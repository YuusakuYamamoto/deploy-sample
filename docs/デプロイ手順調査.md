以下は **GitHub Hosted Runner** を用いて、**IaC（Resource Manager + Terraform）／フロントエンド／バックエンド** をデプロイする手順・構成・費用をまとめ直したものです。Markdown のままコピペしてご利用ください。

---

# 0. ゴールと前提

| 項目     | 内容                                                                     |
| ------ | ---------------------------------------------------------------------- |
| デプロイ対象 | Next.js（frontend）／Nest.js（backend）の 2 サービス                             |
| インフラ   | OCI Container Instances（CI.Standard.E4.Flex を想定）＋ Public Load Balancer |
| IaC    | Terraform を **Resource Manager Stack** で適用                             |
| CI/CD  | **GitHub Actions（GitHub-Hosted Runner）**<br>モノレポ構成                     |
| レジストリ  | OCI Container Registry（OCIR）                                           |
| シークレット | GitHub Secrets に OCI API キー／OCIR 証明書トークンを格納                            |

---

# 1. IaC：Resource Manager × Terraform

1. **リポジトリ構造**（例）

   ```
   /infra
     └ main.tf, variables.tf, terraform.tfvars
   /frontend
   /backend
   ```
2. **Stack 作成**
   コンソール → **Resource Manager ⇒ Stacks ⇒ Create** で GitHub 連携を選択。Git リビジョンを参照して plan/apply が実行される。([docs.oracle.com][1])
3. **Terraform main.tf 抜粋**

   ```hcl
   resource "oci_container_instances_container_instance" "frontend" {
     shape = "CI.Standard.E4.Flex"
     shape_config { ocpus = 2 memory_in_gbs = 4 }
     containers = [{
       display_name = "nextjs"
       image_url    = "${var.ocir}/frontend:${var.tag}"
       ports        = [{ port = 3000, protocol = "TCP" }]
     }]
     vnics = [{ subnet_id = oci_core_subnet.public.id assign_public_ip = false }]
   }
   ```

   *E4* にしておけば A1 在庫枯渇の影響を受けない。([docs.oracle.com][2])

> **Resource Manager 自体は課金なし**。費用は作成される Compute／LB などリソース分のみ ([docs.oracle.com][1])

---

# 2. CI/CD：GitHub Hosted Runner で 3 ジョブ

| ジョブ            | 用途                                         | 主要ステップ                                                                                       |
| -------------- | ------------------------------------------ | -------------------------------------------------------------------------------------------- |
| **iac**        | Terraform plan/apply                       | `hashicorp/setup-terraform` → `terraform fmt` → `terraform plan` → `terraform apply`         |
| **build-push** | Docker build→OCIR push（frontend & backend） | `docker/build-push-action` → `oracle-actions/login-ocir`                                     |
| **deploy**     | Container Instance 更新                      | `oracle-actions/run-oci-cli-command` で `oci container-instances container-instance update …` |

### `.github/workflows/deploy.yml`（骨格）

```yaml
name: ci-cd
on:
  push:
    branches: [ main ]
jobs:
  iac:
    runs-on: ubuntu-latest        # GitHub-Hosted
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
      - run: terraform init && terraform fmt -check && terraform plan -out=tfplan
      - run: terraform apply -auto-approve tfplan
        env: { OCI_CLI_AUTH: api_key, ... }        # OCI 認証
  build-push:
    needs: iac
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - uses: oracle-actions/login-ocir@v1
        with: { auth_token: ${{ secrets.OCI_AUTH_TOKEN }} }
      - name: Build & Push FE
        run: |
          docker build -t $OCIR/fe:${{ github.sha }} ./frontend
          docker push      $OCIR/fe:${{ github.sha }}
  deploy:
    needs: build-push
    runs-on: ubuntu-latest
    steps:
      - uses: oracle-actions/run-oci-cli-command@v1
        with:
          ociCliCommand: >
            oci container-instances container-instance update
            --container-instance-id ${{ secrets.CI_FE_OCID }}
            --containers '[{"displayName":"nextjs","imageUrl":"'"$OCIR/fe:${{ github.sha }}"'"}]'
```

---

# 3. コスト試算（月あたり・24 h 稼働）

| リソース                        | 単価                                             | 構成例         | 月額                                          |
| --------------------------- | ---------------------------------------------- | ----------- | ------------------------------------------- |
| **Container Instance (E4)** | 4 OCPU × \$0.118/OCPU-h + 8 GiB × \$0.015/GB-h | 720 h       | **\$101** ([オラクル][3], [docs.oracle.com][2]) |
| **Load Balancer**           | \$0.0113/h                                     | 720 h       | **\$8.14** ([オラクル][4])                      |
| **OCIR Storage**            | \$0.0255/GB-mo                                 | 10 GB       | **\$0.26** ([オラクル][5])                      |
| **GitHub-Hosted Runner**    | 2 000 分/月無料 → 超過 \$0.008/分（Linux）              | 1 000 分超過想定 | **\$8.00** ([GitHub Docs][6])               |
| **合計**                      |                                                |             | **約 \$117 / 月**                             |

> *A1 (Linux/Arm) が確保できれば* 4 OCPU×\$0.01 + 8 GB×\$0.0015 → **\$31/月** まで圧縮可能。さらに A1 は **月 3 000 OCPU 時間 + 18 000 GB 時間が無料** ([オラクル][7], [オラクル][8])

---

# 4. セキュリティ & 運用ベストプラクティス

| 項目             | 推奨設定                                                                                                                                |
| -------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| **Secrets 管理** | `OCI_CLI_PRIVATE_KEY`, `OCI_TENANCY`, `OCI_USER`, `OCI_FINGERPRINT`, `OCI_AUTH_TOKEN` を GitHub Secrets に保存                          |
| **IAM 最小権限**   | `dynamic-group` に `all {resource.type = 'deploymentpipeline'}` → `Allow dynamic-group to manage container-instances in compartment` |
| **ゼロダウン更新**    | LB のバックエンドポリシーを *draining 30 s* に設定し、CI 更新後ヘルスチェック通過でトラフィック切替                                                                       |
| **監視・アラート**    | OCI Monitoring で OCPU>60 ％ / メモリ>70 ％ を検知 → Slack 連携                                                                                |
| **コスト管理**      | OCI Budgets で \$150/月アラート設定；GitHub も Usage リミットを 10 USD で設定                                                                         |

---

# 5. まとめ

1. **Infrastructure as Code** は Resource Manager Stack（Terraform）で再現性を担保。
2. **GitHub Hosted Runner** で 3 ジョブ構成（IaC → Build/Push → Deploy）。面倒なランナー管理不要、2 000 分／月までは無料。
3. **本番は E4 shape** でキャパシティ不足を回避しつつ、A1 が取れる場合は簡単にダウングレードしてコスト削減可。
4. 追加コストは Compute／LB／Object Storage と、GitHub 分課金（超過分）のみ——スモールスタートでも月 \$100 前後に収まり、運用負荷も最小限です。

[1]: https://docs.oracle.com/en-us/iaas/Content/ResourceManager/Tasks/create-stack-from-csp-git.htm?utm_source=chatgpt.com "Creating a Stack from Git - Oracle Help Center"
[2]: https://docs.oracle.com/en-us/iaas/Content/Compute/References/burstable-instances.htm?utm_source=chatgpt.com "Burstable Instances - Oracle Help Center"
[3]: https://www.oracle.com/cloud/compute/pricing/?utm_source=chatgpt.com "Compute Pricing | Oracle"
[4]: https://www.oracle.com/cloud/networking/pricing/?utm_source=chatgpt.com "Cloud Networking Pricing - Oracle"
[5]: https://www.oracle.com/cloud/storage/pricing/?utm_source=chatgpt.com "Oracle Cloud Storage Pricing"
[6]: https://docs.github.com/en/billing/managing-billing-for-your-products/about-billing-for-github-actions "About billing for GitHub Actions - GitHub Docs"
[7]: https://www.oracle.com/cloud/price-list/?utm_source=chatgpt.com "OCI Price List - Oracle"
[8]: https://www.oracle.com/cloud/price-list/ "Cloud Price List | Oracle"
